<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Me2 PWA åŠŸèƒ½æµ‹è¯•</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #0a0a0a;
      color: #fff;
      padding: 20px;
    }

    .container {
      max-width: 600px;
      margin: 0 auto;
    }

    h1 {
      font-size: 24px;
      margin-bottom: 20px;
    }

    .section {
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 16px;
    }

    .section h2 {
      font-size: 18px;
      margin-bottom: 12px;
      color: #667eea;
    }

    .status {
      padding: 8px 12px;
      border-radius: 4px;
      margin: 8px 0;
      font-size: 14px;
    }

    .status.success {
      background: #10b981;
      color: white;
    }

    .status.error {
      background: #ef4444;
      color: white;
    }

    .status.warning {
      background: #f59e0b;
      color: white;
    }

    .status.info {
      background: #3b82f6;
      color: white;
    }

    button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      margin: 8px 8px 8px 0;
    }

    button:hover {
      opacity: 0.9;
    }

    button:active {
      transform: scale(0.98);
    }

    code {
      background: #0a0a0a;
      padding: 2px 6px;
      border-radius: 3px;
      font-size: 13px;
      color: #a0a0a0;
    }

    .info-item {
      margin: 8px 0;
      font-size: 14px;
    }

    .info-item strong {
      color: #667eea;
      display: inline-block;
      width: 150px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ“± Me2 PWA åŠŸèƒ½æµ‹è¯•</h1>

    <div class="section">
      <h2>ğŸ” æµè§ˆå™¨æ”¯æŒæ£€æµ‹</h2>
      <div id="browser-support"></div>
    </div>

    <div class="section">
      <h2>ğŸ“¦ Service Worker çŠ¶æ€</h2>
      <div id="sw-status"></div>
      <button onclick="registerSW()">æ³¨å†Œ Service Worker</button>
      <button onclick="unregisterSW()">å¸è½½ Service Worker</button>
    </div>

    <div class="section">
      <h2>ğŸ’¾ ç¼“å­˜ç®¡ç†</h2>
      <div id="cache-status"></div>
      <button onclick="checkCaches()">æ£€æŸ¥ç¼“å­˜</button>
      <button onclick="clearCaches()">æ¸…é™¤ç¼“å­˜</button>
    </div>

    <div class="section">
      <h2>ğŸ“² å®‰è£…çŠ¶æ€</h2>
      <div id="install-status"></div>
      <button onclick="promptInstall()">è§¦å‘å®‰è£…æç¤º</button>
    </div>

    <div class="section">
      <h2>ğŸŒ ç½‘ç»œçŠ¶æ€</h2>
      <div id="network-status"></div>
      <button onclick="testOffline()">æµ‹è¯•ç¦»çº¿æ¨¡å¼</button>
    </div>

    <div class="section">
      <h2>ğŸ“Š è®¾å¤‡ä¿¡æ¯</h2>
      <div id="device-info"></div>
    </div>
  </div>

  <script>
    // æµè§ˆå™¨æ”¯æŒæ£€æµ‹
    function checkBrowserSupport() {
      const container = document.getElementById('browser-support');
      const checks = [
        { name: 'Service Worker', supported: 'serviceWorker' in navigator },
        { name: 'Push API', supported: 'PushManager' in window },
        { name: 'Notification API', supported: 'Notification' in window },
        { name: 'Cache API', supported: 'caches' in window },
        { name: 'Background Sync', supported: 'sync' in navigator.serviceWorker || false },
      ];

      container.innerHTML = checks.map(check =>
        `<div class="status ${check.supported ? 'success' : 'error'}">
          ${check.name}: ${check.supported ? 'âœ… æ”¯æŒ' : 'âŒ ä¸æ”¯æŒ'}
        </div>`
      ).join('');
    }

    // Service Worker çŠ¶æ€
    async function checkSWStatus() {
      const container = document.getElementById('sw-status');

      if (!('serviceWorker' in navigator)) {
        container.innerHTML = '<div class="status error">æµè§ˆå™¨ä¸æ”¯æŒ Service Worker</div>';
        return;
      }

      const registration = await navigator.serviceWorker.getRegistration();

      if (registration) {
        const state = registration.active ? registration.active.state : 'æœªæ¿€æ´»';
        container.innerHTML = `
          <div class="status success">âœ… Service Worker å·²æ³¨å†Œ</div>
          <div class="info-item"><strong>çŠ¶æ€:</strong> ${state}</div>
          <div class="info-item"><strong>Scope:</strong> <code>${registration.scope}</code></div>
        `;
      } else {
        container.innerHTML = '<div class="status warning">âš ï¸ Service Worker æœªæ³¨å†Œ</div>';
      }
    }

    async function registerSW() {
      try {
        const registration = await navigator.serviceWorker.register('/sw.js');
        console.log('SW registered:', registration);
        checkSWStatus();
        alert('Service Worker æ³¨å†ŒæˆåŠŸï¼');
      } catch (error) {
        console.error('SW registration failed:', error);
        alert('æ³¨å†Œå¤±è´¥: ' + error.message);
      }
    }

    async function unregisterSW() {
      const registration = await navigator.serviceWorker.getRegistration();
      if (registration) {
        await registration.unregister();
        checkSWStatus();
        alert('Service Worker å·²å¸è½½');
      }
    }

    // ç¼“å­˜ç®¡ç†
    async function checkCaches() {
      const container = document.getElementById('cache-status');

      if (!('caches' in window)) {
        container.innerHTML = '<div class="status error">æµè§ˆå™¨ä¸æ”¯æŒ Cache API</div>';
        return;
      }

      const cacheNames = await caches.keys();
      let totalSize = 0;

      const cacheInfo = await Promise.all(
        cacheNames.map(async name => {
          const cache = await caches.open(name);
          const keys = await cache.keys();
          return { name, count: keys.length };
        })
      );

      if (cacheNames.length === 0) {
        container.innerHTML = '<div class="status warning">æš‚æ— ç¼“å­˜æ•°æ®</div>';
      } else {
        container.innerHTML = cacheInfo.map(info =>
          `<div class="info-item">
            <strong>${info.name}:</strong> ${info.count} ä¸ªæ–‡ä»¶
          </div>`
        ).join('');
      }
    }

    async function clearCaches() {
      const cacheNames = await caches.keys();
      await Promise.all(cacheNames.map(name => caches.delete(name)));
      checkCaches();
      alert('ç¼“å­˜å·²æ¸…é™¤ï¼');
    }

    // å®‰è£…çŠ¶æ€
    function checkInstallStatus() {
      const container = document.getElementById('install-status');
      const isStandalone = window.matchMedia('(display-mode: standalone)').matches
        || window.navigator.standalone
        || document.referrer.includes('android-app://');

      if (isStandalone) {
        container.innerHTML = '<div class="status success">âœ… å·²å®‰è£…ä¸ºç‹¬ç«‹åº”ç”¨</div>';
      } else {
        container.innerHTML = '<div class="status info">â„¹ï¸ åœ¨æµè§ˆå™¨ä¸­è¿è¡Œ</div>';
      }
    }

    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      console.log('Install prompt available');
    });

    async function promptInstall() {
      if (!deferredPrompt) {
        alert('å®‰è£…æç¤ºä¸å¯ç”¨ã€‚å¯èƒ½å·²ç»å®‰è£…ï¼Œæˆ–æµè§ˆå™¨ä¸æ”¯æŒã€‚');
        return;
      }

      deferredPrompt.prompt();
      const { outcome } = await deferredPrompt.userChoice;
      console.log('Install outcome:', outcome);
      deferredPrompt = null;
    }

    // ç½‘ç»œçŠ¶æ€
    function checkNetworkStatus() {
      const container = document.getElementById('network-status');
      const online = navigator.onLine;

      container.innerHTML = `
        <div class="status ${online ? 'success' : 'error'}">
          ${online ? 'âœ… åœ¨çº¿' : 'âŒ ç¦»çº¿'}
        </div>
        <div class="info-item"><strong>è¿æ¥ç±»å‹:</strong> ${navigator.connection ? navigator.connection.effectiveType : 'æœªçŸ¥'}</div>
      `;
    }

    window.addEventListener('online', checkNetworkStatus);
    window.addEventListener('offline', checkNetworkStatus);

    function testOffline() {
      alert('è¯·æ‰“å¼€å¼€å‘è€…å·¥å…·ï¼Œåˆ‡æ¢åˆ° Network æ ‡ç­¾ï¼Œé€‰æ‹© Offline æ¨¡å¼è¿›è¡Œæµ‹è¯•');
    }

    // è®¾å¤‡ä¿¡æ¯
    function checkDeviceInfo() {
      const container = document.getElementById('device-info');
      container.innerHTML = `
        <div class="info-item"><strong>User Agent:</strong> <code>${navigator.userAgent}</code></div>
        <div class="info-item"><strong>å¹³å°:</strong> ${navigator.platform}</div>
        <div class="info-item"><strong>è¯­è¨€:</strong> ${navigator.language}</div>
        <div class="info-item"><strong>å±å¹•å°ºå¯¸:</strong> ${screen.width} Ã— ${screen.height}</div>
        <div class="info-item"><strong>è§†å£å°ºå¯¸:</strong> ${window.innerWidth} Ã— ${window.innerHeight}</div>
        <div class="info-item"><strong>è®¾å¤‡åƒç´ æ¯”:</strong> ${window.devicePixelRatio}</div>
      `;
    }

    // åˆå§‹åŒ–
    window.addEventListener('load', () => {
      checkBrowserSupport();
      checkSWStatus();
      checkCaches();
      checkInstallStatus();
      checkNetworkStatus();
      checkDeviceInfo();
    });
  </script>
</body>
</html>
