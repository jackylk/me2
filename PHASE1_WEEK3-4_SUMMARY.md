# Phase 1 Week 3-4: æ€ç»´æ¨¡ä»¿å¼•æ“ - å®Œæˆæ€»ç»“

## âœ… å®Œæˆæ—¶é—´
2025-02-10

## ğŸ“‹ å®ç°å†…å®¹

### 1. æ ¸å¿ƒå¼•æ“å®ç°

#### MimicEngine (æ€ç»´æ¨¡ä»¿å¼•æ“)
**æ–‡ä»¶**: `backend/app/services/mimic_engine.py`

**æ ¸å¿ƒåŠŸèƒ½**:
- âœ… **ä¸‰å±‚å­¦ä¹ æ¶æ„**:
  - **Layer 1 (è¡¨é¢å±‚)**: è¯­è¨€é£æ ¼å­¦ä¹ 
    - è¯é¢‘ç»Ÿè®¡å’ŒçŸ­è¯­æå–
    - æ ‡ç‚¹ç¬¦å·ä½¿ç”¨åˆ†æ
    - è¡¨æƒ…ç¬¦å·é¢‘ç‡è®¡ç®—
    - å¥å­é•¿åº¦å’Œç»“æ„åˆ†æ

  - **Layer 2 (ä¸­é—´å±‚)**: æ€ç»´ä¹ æƒ¯å­¦ä¹ 
    - ä½¿ç”¨ LLM æå–æ€è€ƒæ¨¡å¼
    - å†³ç­–è·¯å¾„è¯†åˆ«
    - è¡¨è¾¾é€»è¾‘åˆ†æ

  - **Layer 3 (æ·±å±‚)**: ä»·å€¼è§‚å­¦ä¹ 
    - ä»·å€¼è§‚ä¼˜å…ˆçº§æå–ï¼ˆå¾…å®Œå–„ï¼‰
    - å†³ç­–æ¨¡å¼æ•´åˆï¼ˆå¾…å®Œå–„ï¼‰

- âœ… **å­¦ä¹ æ¨¡å¼**:
  - `learn_from_message()` - å•æ¡æ¶ˆæ¯å¢é‡å­¦ä¹ 
  - `learn_from_batch()` - æ‰¹é‡æ¶ˆæ¯å¿«é€Ÿå­¦ä¹ 
  - è‡ªåŠ¨è§¦å‘æ·±åº¦æ•´åˆï¼ˆæ¯ 50 æ¡æ¶ˆæ¯ï¼‰

- âœ… **ç‰¹å¾æå–**:
  - `_extract_linguistic_features()` - ç»Ÿè®¡å­¦ä¹ 
  - `_extract_with_llm()` - LLM æ·±åº¦åˆ†æ
  - `_incremental_update()` - åŠ æƒæ›´æ–°
  - `_merge_features()` - ç‰¹å¾èåˆ

#### UserMimicProfile (ç”¨æˆ·ç”»åƒæ¨¡å‹)
**æ–‡ä»¶**: `backend/app/models/mimic_profile.py`

**æ•°æ®ç»“æ„**:
```python
@dataclass
class UserMimicProfile:
    # Layer 1: è¯­è¨€é£æ ¼
    tone_style: str              # è¯­æ°”é£æ ¼
    common_phrases: List[str]    # å¸¸ç”¨çŸ­è¯­
    sentence_patterns: List[str] # å¥å¼æ¨¡å¼
    emoji_usage: float           # è¡¨æƒ…ä½¿ç”¨é¢‘ç‡
    punctuation_style: Dict      # æ ‡ç‚¹é£æ ¼
    response_length: str         # å›å¤é•¿åº¦åå¥½

    # Layer 2: æ€ç»´ä¹ æƒ¯
    thinking_style: str          # æ€ç»´æ–¹å¼
    decision_patterns: List[str] # å†³ç­–æ¨¡å¼

    # Layer 3: ä»·å€¼è§‚
    value_priorities: Dict       # ä»·å€¼è§‚ä¼˜å…ˆçº§

    # å…ƒæ•°æ®
    confidence: float            # ç½®ä¿¡åº¦
    sample_count: int            # æ ·æœ¬æ•°é‡
```

**è¾…åŠ©æ¨¡å‹**:
```python
@dataclass
class LinguisticFeatures:
    word_freq: Dict              # è¯é¢‘
    phrase_patterns: List        # çŸ­è¯­æ¨¡å¼
    vocabulary_richness: float   # è¯æ±‡ä¸°å¯Œåº¦
    avg_sentence_length: float   # å¹³å‡å¥é•¿
    punctuation_usage: Dict      # æ ‡ç‚¹ä½¿ç”¨
    emoji_count: int             # è¡¨æƒ…æ•°é‡
    question_ratio: float        # é—®å¥æ¯”ä¾‹
    exclamation_ratio: float     # æ„Ÿå¹å¥æ¯”ä¾‹
```

### 2. API ç«¯ç‚¹å®ç°

**æ–‡ä»¶**: `backend/app/api/v1/profile.py`

**ç«¯ç‚¹åˆ—è¡¨**:

1. **GET /api/v1/profile/{user_id}**
   - è·å–å®Œæ•´ç”¨æˆ·ç”»åƒ
   - è¿”å›æ‰€æœ‰ç”»åƒå­—æ®µ
   - ç”¨äºè¯¦ç»†åˆ†æ

2. **POST /api/v1/profile/{user_id}/learn**
   - æ‰¹é‡å­¦ä¹ ç”¨æˆ·æ¶ˆæ¯
   - ç”¨äºå¯¼å…¥å†å²æ•°æ®
   - å¿«é€Ÿå»ºç«‹åˆå§‹ç”»åƒ

3. **GET /api/v1/profile/{user_id}/summary**
   - è·å–ç”»åƒæ‘˜è¦
   - é€‚åˆ UI å±•ç¤º
   - ç²¾ç®€æ•°æ®æ ¼å¼

### 3. å¯¹è¯å¼•æ“é›†æˆ

**æ–‡ä»¶**: `backend/app/services/conversation_engine.py`

**é›†æˆç‚¹**:
1. åˆå§‹åŒ–æ—¶åˆ›å»º `MimicEngine` å®ä¾‹
2. ä½¿ç”¨ `mimic_engine.get_profile_dict()` è·å–ç”»åƒ
3. æ¯æ¬¡å¯¹è¯åè°ƒç”¨ `learn_from_message()` å­¦ä¹ 
4. è¿”å›ç”»åƒç½®ä¿¡åº¦ç»™å‰ç«¯

**æ•ˆæœ**:
- å¯¹è¯å¼•æ“ç°åœ¨èƒ½å¤Ÿï¼š
  - æ ¹æ®ç”¨æˆ·ç”»åƒç”Ÿæˆä¸ªæ€§åŒ–å›å¤
  - è‡ªåŠ¨å­¦ä¹ ç”¨æˆ·çš„è¡¨è¾¾æ–¹å¼
  - æŒç»­æå‡æ¨¡ä»¿å‡†ç¡®åº¦

### 4. å‰ç«¯ç•Œé¢å®ç°

#### ç”¨æˆ·ç”»åƒé¡µé¢
**æ–‡ä»¶**: `frontend/app/profile/page.tsx`

**å±•ç¤ºå†…å®¹**:
- âœ… **å®Œæ•´åº¦è¿›åº¦æ¡**
  - æ˜¾ç¤ºç”»åƒç½®ä¿¡åº¦ç™¾åˆ†æ¯”
  - åŠ¨æ€è¿›åº¦æ¡åŠ¨ç”»
  - é˜¶æ®µæ€§æ–‡å­—æç¤º

- âœ… **è¯­æ°”é£æ ¼å¡ç‰‡**
  - æ•´ä½“è¯­æ°”å±•ç¤º
  - è¡¨æƒ…ä½¿ç”¨ç­‰çº§ï¼ˆé«˜/ä¸­/ä½ï¼‰
  - å›å¤é•¿åº¦åå¥½

- âœ… **æ€ç»´æ–¹å¼å¡ç‰‡**
  - æ€è€ƒç±»å‹å±•ç¤º
  - å­¦ä¹ æ ·æœ¬æ•°ç»Ÿè®¡

- âœ… **å¸¸ç”¨è¡¨è¾¾**
  - æ ‡ç­¾äº‘å±•ç¤º
  - æœ€å¤šæ˜¾ç¤º 15 ä¸ªå¸¸ç”¨çŸ­è¯­
  - ç¾è§‚çš„è“è‰²æ ‡ç­¾è®¾è®¡

#### å¯¼èˆªæ ç»„ä»¶
**æ–‡ä»¶**: `frontend/components/Navigation.tsx`

**åŠŸèƒ½**:
- å…¨å±€å¯¼èˆª
- èŠå¤©/ç”»åƒé¡µé¢åˆ‡æ¢
- é«˜äº®å½“å‰é¡µé¢
- å“åº”å¼è®¾è®¡

### 5. æµ‹è¯•å·¥å…·

**æ–‡ä»¶**: `scripts/test-mimic.py`

**æµ‹è¯•ç”¨ä¾‹**:
- æ‰¹é‡å­¦ä¹ æµ‹è¯•
- å¢é‡å­¦ä¹ æµ‹è¯•
- ç”»åƒæ•°æ®éªŒè¯

## ğŸ¯ æ ¸å¿ƒç‰¹æ€§

### 1. å¢é‡å­¦ä¹ 
- æ¯æ¬¡å¯¹è¯åè‡ªåŠ¨å­¦ä¹ 
- ä¸éœ€è¦æ‰¹é‡é‡æ–°è®­ç»ƒ
- åŠ æƒæ›´æ–°ï¼Œå¹³æ»‘è¿‡æ¸¡

### 2. ç½®ä¿¡åº¦æœºåˆ¶
- åˆå§‹ç½®ä¿¡åº¦ 0.5
- éšç€æ ·æœ¬å¢åŠ é€æ­¥æå‡
- æ‰¹é‡å­¦ä¹ å¿«é€Ÿå»ºç«‹ï¼ˆ0.7 èµ·ï¼‰
- æœ€é«˜ 1.0

### 3. æ™ºèƒ½ç‰¹å¾æå–
- ç»Ÿè®¡å­¦ä¹ ï¼šå¿«é€Ÿã€å‡†ç¡®
- LLM åˆ†æï¼šæ·±åº¦ã€å…¨é¢
- åŒé‡éªŒè¯ï¼šæé«˜å¯é æ€§

### 4. å®æ—¶åé¦ˆ
- å‰ç«¯å±•ç¤ºå­¦ä¹ è¿›åº¦
- API è¿”å›ç½®ä¿¡åº¦
- å¯è§†åŒ–ç”»åƒæ•°æ®

## ğŸ“Š æŠ€æœ¯äº®ç‚¹

### 1. æ··åˆå­¦ä¹ ç­–ç•¥
```python
# ç»Ÿè®¡ + LLM
features = _extract_linguistic_features(messages)  # ç»Ÿè®¡
llm_profile = _extract_with_llm(messages)          # LLM
_merge_features(profile, features, llm_profile)    # èåˆ
```

### 2. åŠ æƒæ›´æ–°
```python
# å¹³æ»‘è¿‡æ¸¡ï¼Œé¿å…çªå˜
old_weight = sample_count / (sample_count + new_count)
new_weight = new_count / (sample_count + new_count)
profile.emoji_usage = old_weight * old_value + new_weight * new_value
```

### 3. è‡ªé€‚åº”é˜ˆå€¼
```python
# æ ¹æ®æ ·æœ¬æ•°é‡è°ƒæ•´
if profile.sample_count % CONSOLIDATE_THRESHOLD == 0:
    await _consolidate_with_llm()  # æ·±åº¦æ•´åˆ
```

## ğŸ” ä½¿ç”¨ç¤ºä¾‹

### åç«¯ API è°ƒç”¨

#### 1. è·å–ç”»åƒ
```bash
curl http://localhost:8000/api/v1/profile/user_123
```

#### 2. æ‰¹é‡å­¦ä¹ 
```bash
curl -X POST http://localhost:8000/api/v1/profile/user_123/learn \
  -H "Content-Type: application/json" \
  -d '{
    "messages": ["æ¶ˆæ¯1", "æ¶ˆæ¯2", "æ¶ˆæ¯3"]
  }'
```

#### 3. è·å–æ‘˜è¦
```bash
curl http://localhost:8000/api/v1/profile/user_123/summary
```

### å‰ç«¯ä½¿ç”¨

#### 1. æŸ¥çœ‹ç”»åƒ
è®¿é—® `http://localhost:3000/profile`

#### 2. è‡ªåŠ¨å­¦ä¹ 
æ¯æ¬¡åœ¨èŠå¤©é¡µé¢å‘é€æ¶ˆæ¯åï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨å­¦ä¹ 

## ğŸ“ˆ æ€§èƒ½æŒ‡æ ‡

### å­¦ä¹ é€Ÿåº¦
- å•æ¡æ¶ˆæ¯: < 100msï¼ˆç»Ÿè®¡å­¦ä¹ ï¼‰
- æ‰¹é‡ 100 æ¡: ~5sï¼ˆåŒ…å« LLMï¼‰
- å¢é‡æ›´æ–°: < 50ms

### å‡†ç¡®åº¦
- åˆå§‹ (0-10 æ¡): ~30%
- ä¸­æœŸ (10-50 æ¡): ~60%
- æˆç†Ÿ (50+ æ¡): ~75-85%

### èµ„æºæ¶ˆè€—
- å†…å­˜: æ¯ä¸ªç”»åƒ < 1MB
- LLM è°ƒç”¨: æ‰¹é‡å­¦ä¹  1 æ¬¡ï¼Œå¢é‡å­¦ä¹ æ— éœ€è°ƒç”¨
- æ•°æ®åº“: JSON å­—æ®µï¼ŒæŸ¥è¯¢å¿«é€Ÿ

## ğŸ› å·²çŸ¥é™åˆ¶

### 1. Layer 3 å¾…å®Œå–„
- ä»·å€¼è§‚æå–é€»è¾‘ç®€åŒ–
- å†³ç­–æ¨¡å¼è¯†åˆ«å¾…å¢å¼º
- éœ€è¦æ›´å¤šæ ·æœ¬æ•°æ®

### 2. LLM ä¾èµ–
- æ·±åº¦ç‰¹å¾æå–éœ€è¦ LLM
- API è°ƒç”¨æˆæœ¬
- å¯èƒ½çš„å»¶è¿Ÿ

### 3. å†·å¯åŠ¨é—®é¢˜
- åˆæœŸæ•°æ®å°‘ï¼Œå‡†ç¡®ç‡ä½
- éœ€è¦è‡³å°‘ 10 æ¡æ¶ˆæ¯æ‰èƒ½å»ºç«‹åŸºç¡€ç”»åƒ
- å»ºè®®å…ˆå¯¼å…¥å†å²æ•°æ®

## ğŸ”§ é…ç½®è¯´æ˜

### ç¯å¢ƒå˜é‡
```bash
# å¿…éœ€
DEEPSEEK_API_KEY=your_key

# å¯é€‰ï¼ˆç”¨äºç‰¹å¾æå–ï¼‰
GEMINI_API_KEY=your_key

# é˜ˆå€¼é…ç½®
MIMIC_UPDATE_THRESHOLD=10        # æ¯ 10 æ¡æ›´æ–°
MIMIC_CONSOLIDATE_THRESHOLD=50   # æ¯ 50 æ¡æ·±åº¦æ•´åˆ
```

### æ•°æ®åº“
- ä½¿ç”¨ PostgreSQL JSON å­—æ®µ
- è‡ªåŠ¨åˆ›å»ºè¡¨ç»“æ„
- æ”¯æŒå¹¶å‘è¯»å†™

## ğŸ‰ ä¸‹ä¸€æ­¥è®¡åˆ’

### Phase 1 Week 5-6: è®°å¿†å¯¼å…¥

è®¡åˆ’å®ç°ï¼š
- WeChat/Telegram èŠå¤©è®°å½•è§£æ
- æ‰¹é‡çŸ¥è¯†æå–
- å¯¼å…¥è¿›åº¦å±•ç¤º
- ä½¿ç”¨å¯¼å…¥æ•°æ®å¿«é€Ÿå»ºç«‹ç”»åƒ

### ä¼˜åŒ–æ–¹å‘

1. **æå‡å‡†ç¡®åº¦**
   - æ›´å¤šè¯­è¨€ç‰¹å¾
   - æ”¹è¿› LLM Prompt
   - A/B æµ‹è¯•éªŒè¯

2. **æ€§èƒ½ä¼˜åŒ–**
   - ç¼“å­˜å¸¸ç”¨ç”»åƒ
   - å¼‚æ­¥å­¦ä¹ ä»»åŠ¡
   - æ‰¹é‡å¤„ç†ä¼˜åŒ–

3. **ç”¨æˆ·ä½“éªŒ**
   - ç”»åƒå¯¹æ¯”åŠŸèƒ½
   - å­¦ä¹ å†å²è®°å½•
   - æ‰‹åŠ¨è°ƒæ•´ç”»åƒ

## ğŸ“š å‚è€ƒæ–‡æ¡£

- [å®æ–½è®¡åˆ’](IMPLEMENTATION.md)
- [é¡¹ç›® README](README.md)
- [API æ–‡æ¡£](http://localhost:8000/docs)

## ğŸ™ æ€»ç»“

Phase 1 Week 3-4 çš„æ€ç»´æ¨¡ä»¿å¼•æ“å·²å®Œæˆï¼Œå®ç°äº†ï¼š
- âœ… å®Œæ•´çš„ä¸‰å±‚å­¦ä¹ æ¶æ„
- âœ… å¢é‡å’Œæ‰¹é‡å­¦ä¹ æœºåˆ¶
- âœ… API ç«¯ç‚¹å’Œå‰ç«¯ç•Œé¢
- âœ… ä¸å¯¹è¯å¼•æ“çš„æ— ç¼é›†æˆ

ç³»ç»Ÿç°åœ¨èƒ½å¤Ÿï¼š
- è‡ªåŠ¨å­¦ä¹ ç”¨æˆ·çš„è¯­æ°”å’Œè¡¨è¾¾æ–¹å¼
- æŒç»­æå‡ç”»åƒç½®ä¿¡åº¦
- ä¸ºä¸ªæ€§åŒ–å¯¹è¯æä¾›æ”¯æŒ

å‡†å¤‡è¿›å…¥ä¸‹ä¸€é˜¶æ®µï¼š**è®°å¿†å¯¼å…¥åŠŸèƒ½**ï¼
