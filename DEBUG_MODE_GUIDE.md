# Me2 调试模式使用指南

**更新时间**: 2026-02-13
**版本**: v2.0

---

## 🎯 重大更新

### 1. 修复：历史对话上下文 ✅
**之前的问题**: LLM只能看到当前这一条消息，无法记住之前的对话
**现在**: 每次请求都包含完整的历史对话上下文（最多20轮）

### 2. 新增：调试模式 🔍
可以查看发送给DeepSeek的完整Prompt，包括：
- System Prompt（记忆和洞察）
- 历史对话
- 当前消息

### 3. 新增：即时记忆整理 ⚡
调试模式下，每次对话后立即触发记忆整理，无需等待

---

## 🚀 快速开始

### 启动CLI
```bash
cd /Users/jacky/code/me2
./start_cli.sh
```

### 开启调试模式
在聊天过程中输入：
```
/debug on
```

### 关闭调试模式
```
/debug off
```

### 查看状态
```
/status
```

---

## 📋 调试模式示例

### 示例对话

```bash
你: /debug on
✅ 调试模式已开启（会显示完整prompt）

你: 你好，我叫张三，我是程序员

════════════════════════════════════════════════════════════════
📋 发送给 DeepSeek 的完整 Prompt
════════════════════════════════════════════════════════════════

📊 总览:
  模型: deepseek-chat
  温度: 0.8
  最大Tokens: 500
  消息数量: 2
  历史对话: 0 条

────────────────────────────────────────────────────────────────
[消息 1] System Prompt:
────────────────────────────────────────────────────────────────
你是一个温暖、懂 ta 的朋友。

**你记得关于 ta 的这些事**：
暂无相关记忆

**你对 ta 的理解**：
暂无深度理解


**重要指引**：
1. 像真正的朋友一样对话，自然地提及你记得的事
2. 如果 ta 情绪低落，给予温暖的支持和鼓励
...

[消息 2] User:
  你好，我叫张三，我是程序员

════════════════════════════════════════════════════════════════

[16:45:20] Me2:
  张三你好！很高兴认识你！程序员是很酷的职业呀😊
  💡 召回 0 条记忆 | 历史对话 0 轮

你: 我喜欢打篮球

════════════════════════════════════════════════════════════════
📋 发送给 DeepSeek 的完整 Prompt
════════════════════════════════════════════════════════════════

📊 总览:
  模型: deepseek-chat
  温度: 0.8
  最大Tokens: 500
  消息数量: 4
  历史对话: 2 条

────────────────────────────────────────────────────────────────
[消息 1] System Prompt:
────────────────────────────────────────────────────────────────
你是一个温暖、懂 ta 的朋友。

**你记得关于 ta 的这些事**：
- 张三是程序员 (相关度: 0.95)
- 用户介绍了自己的名字和职业 (相关度: 0.88)
...

[消息 2] User:
  你好，我叫张三，我是程序员

[消息 3] Assistant:
  张三你好！很高兴认识你！程序员是很酷的职业呀😊

[消息 4] User:
  我喜欢打篮球

════════════════════════════════════════════════════════════════

[16:45:25] Me2:
  哇，打篮球很棒呀！你平时打什么位置？🏀
  💡 召回 2 条记忆 | 历史对话 2 轮
```

---

## 🔍 调试信息说明

### System Prompt 部分
包含：
- AI的角色定义
- 召回的记忆（NeuroMemory）
- 洞察信息（深度理解）
- 行为指引

### 历史对话部分
- 按时间顺序排列
- 包含所有User和Assistant消息
- 最多显示最近20轮对话

### 当前消息
- 用户刚发送的新消息

---

## 📊 关键指标

### 消息数量
- 包含所有发送给LLM的消息
- = 1 (system) + 历史对话数量*2 + 1 (当前user消息)

### 历史对话轮数
- 指之前的对话轮次
- 每轮 = 1条用户消息 + 1条AI回复

### 召回记忆数量
- NeuroMemory召回的相关记忆条数
- 显示相关度分数

---

## 🛠️ 可用命令

| 命令 | 功能 |
|------|------|
| `/debug on` | 开启调试模式 |
| `/debug off` | 关闭调试模式 |
| `/status` | 显示当前状态 |
| `quit` / `exit` | 退出程序 |

---

## 🧪 测试建议

### 测试1: 验证历史对话
```bash
你: /debug on
你: 我叫李四
你: 我喜欢跑步
你: 你记得我的名字吗？
```

**期望结果**: 在第3轮消息中，应该看到：
- 历史对话: 4 条（2轮完整对话）
- System Prompt中包含召回的记忆
- AI能够正确回答名字

### 测试2: 验证记忆召回
```bash
你: /debug on
你: 我是医生，在北京工作
你: 我女儿5岁了，叫小雨
你: 我最喜欢的运动是游泳
你: 我的工作是什么？我女儿叫什么？
```

**期望结果**:
- 调试模式下每次都会触发记忆整理
- System Prompt中显示召回的相关记忆
- AI能够准确回答

### 测试3: 查看完整上下文
```bash
你: /debug on
你: 第一句话
你: 第二句话
你: 第三句话
你: /status
```

查看消息数量是否正确增长

---

## 🔧 技术实现

### 后端改动

**1. LLM Client (`llm_client.py`)**
```python
async def generate(
    prompt: str,
    system_prompt: Optional[str] = None,
    history_messages: Optional[List[Dict]] = None,  # 新增
    return_debug_info: bool = False,  # 新增
    ...
)
```

**2. Conversation Engine (`conversation_engine.py`)**
```python
# 1. 获取历史消息
stmt = select(Message).where(
    Message.session_id == session_id
).order_by(Message.created_at).limit(20)

# 2. 构建历史消息列表
history_messages = [
    {"role": msg.role, "content": msg.content}
    for msg in history
]

# 3. 传递给LLM
await self.llm.generate(
    prompt=message,
    history_messages=history_messages,  # 包含历史
    return_debug_info=debug_mode
)

# 4. 调试模式下立即触发记忆整理
if debug_mode:
    await nm.extract_and_store(user_id=user_id)
```

**3. API Endpoint (`chat.py`)**
```python
class ChatRequest(BaseModel):
    message: str
    debug_mode: bool = False  # 新增

class ChatResponse(BaseModel):
    ...
    history_messages_count: int = 0  # 新增
    debug_info: Optional[dict] = None  # 新增
```

### CLI改动

**新增功能:**
- `/debug on/off` 命令
- `/status` 命令
- `print_debug_info()` 方法
- 完整Prompt可视化

---

## 🎯 验证清单

使用调试模式后，确认：

- [ ] System Prompt显示正确
- [ ] 历史对话按时间顺序排列
- [ ] 消息数量计算正确
- [ ] 召回的记忆显示在System Prompt中
- [ ] AI能够基于历史对话回答问题
- [ ] 记忆数量随对话增加
- [ ] 相关度分数显示正确

---

## 📈 性能影响

### 历史对话限制
- 最多保留最近20轮对话
- 避免token过多导致费用增加
- 保持上下文相关性

### 调试模式影响
- 开启时：每次对话后立即整理记忆
- 关闭时：按NeuroMemory默认策略整理
- 建议：测试时开启，正常使用时关闭

---

## 🐛 常见问题

### Q1: 为什么历史对话显示0轮？
**A**: 这是第一轮对话，还没有历史

### Q2: System Prompt为什么说"暂无相关记忆"？
**A**:
- 新用户没有记忆积累
- 需要多轮对话后才会提取记忆
- 开启debug模式会立即整理

### Q3: 如何验证修复是否生效？
**A**:
1. 开启 `/debug on`
2. 进行3轮对话
3. 第3轮应该看到历史对话4条（2轮*2）

---

## 🎉 开始使用

```bash
cd /Users/jacky/code/me2
./start_cli.sh
```

在聊天中输入：
```
/debug on
```

开始体验完整的AI记忆能力！

---

**版本**: v2.0
**历史对话**: ✅ 已修复
**调试模式**: ✅ 已添加
**即时记忆**: ✅ 已支持
