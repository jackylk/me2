# è®°å¿†ç³»ç»Ÿä¿®å¤å®ŒæˆæŠ¥å‘Š

**æ—¥æœŸ**: 2026-02-13
**çŠ¶æ€**: âœ… å®Œå…¨ä¿®å¤
**æµ‹è¯•ç»“æœ**: âœ… é€šè¿‡

---

## ğŸ¯ ä¿®å¤æ€»ç»“

### é—®é¢˜ 1: å†å²å¯¹è¯æœªä¼ é€’ âœ… å·²ä¿®å¤
**ç—‡çŠ¶**: æ¯è½®å¯¹è¯éƒ½æ˜¾ç¤º"å†å²å¯¹è¯: 0 æ¡"
**åŸå› **: æµ‹è¯•è„šæœ¬æ²¡æœ‰å¤ç”¨ session_idï¼Œæ¯æ¬¡éƒ½åˆ›å»ºæ–°ä¼šè¯
**ä¿®å¤**: åœ¨æµ‹è¯•è„šæœ¬ä¸­æ•è·å¹¶å¤ç”¨ session_id

### é—®é¢˜ 2: è®°å¿†å¬å›å¤±è´¥ âœ… å·²ä¿®å¤
**ç—‡çŠ¶**: æ¯è½®éƒ½æ˜¾ç¤º"å¬å› 0 æ¡è®°å¿†"ï¼ŒSystem Prompt æ˜¾ç¤º"æš‚æ— ç›¸å…³è®°å¿†"
**åŸå› **: NeuroMemory API ä½¿ç”¨ä¸å½“ï¼Œæ–¹æ³•è°ƒç”¨é”™è¯¯
**ä¿®å¤**: æ­£ç¡®ä½¿ç”¨ NeuroMemory API è¿›è¡Œè®°å¿†æå–å’Œå¬å›

---

## ğŸ”§ ä¿®å¤ç»†èŠ‚

### 1. æµ‹è¯•è„šæœ¬ä¿®å¤ (`test_debug_mode.py`)

**ä¹‹å‰çš„é—®é¢˜**:
```python
# æ¯æ¬¡è°ƒç”¨éƒ½æ²¡æœ‰ä¼ é€’ session_id
result = chat(token, "ä½ å¥½ï¼Œæˆ‘å«å¼ ä¸‰ï¼Œæˆ‘æ˜¯ç¨‹åºå‘˜", debug_mode=True)
result = chat(token, "æˆ‘å–œæ¬¢æ‰“ç¯®çƒ", debug_mode=True)  # âŒ æ–°ä¼šè¯ï¼
```

**ä¿®å¤å**:
```python
def chat(token, message, session_id=None, debug_mode=False):
    payload = {"message": message, "debug_mode": debug_mode}
    if session_id:
        payload["session_id"] = session_id  # âœ… å¤ç”¨ä¼šè¯

# ä½¿ç”¨æ—¶
session_id = None
result = chat(token, "ä½ å¥½ï¼Œæˆ‘å«å¼ ä¸‰ï¼Œæˆ‘æ˜¯ç¨‹åºå‘˜", session_id=session_id, debug_mode=True)
session_id = result.get("session_id")  # âœ… æ•è·ä¼šè¯ID

result = chat(token, "æˆ‘å–œæ¬¢æ‰“ç¯®çƒ", session_id=session_id, debug_mode=True)  # âœ… å¤ç”¨ä¼šè¯
```

### 2. NeuroMemory API ä¿®å¤ (`conversation_engine.py`)

**é”™è¯¯å°è¯• 1**: æ–¹æ³•åé”™è¯¯
```python
await nm.extract_and_store(user_id=user_id)  # âŒ æ–¹æ³•ä¸å­˜åœ¨
```

**é”™è¯¯å°è¯• 2**: å‚æ•°æ ¼å¼é”™è¯¯
```python
current_messages = [
    {"role": "user", "content": message},  # âŒ NeuroMemory éœ€è¦å¯¹è±¡ï¼Œä¸æ˜¯å­—å…¸
    {"role": "assistant", "content": response}
]
await nm.extract_memories(user_id=user_id, messages=current_messages)
```

**é”™è¯¯å°è¯• 3**: æ–¹æ³•ä½ç½®é”™è¯¯
```python
await nm.get_unextracted_messages(user_id=user_id)  # âŒ åº”è¯¥æ˜¯ nm.conversations
```

**æœ€ç»ˆæ­£ç¡®æ–¹æ¡ˆ**:
```python
# è·å–æœªæå–çš„æ¶ˆæ¯ï¼ˆNeuroMemory ä¼šè·Ÿè¸ªå“ªäº›æ¶ˆæ¯å·²æå–ï¼‰
unextracted_messages = await nm.conversations.get_unextracted_messages(user_id=user_id)

if unextracted_messages:
    # æå–å¹¶å­˜å‚¨è®°å¿†
    await nm.extract_memories(user_id=user_id, messages=unextracted_messages)

# ç”Ÿæˆæ´å¯Ÿï¼ˆåæ€ï¼‰
await nm.reflect(user_id=user_id, limit=50)
```

### 3. JSON åºåˆ—åŒ–ä¿®å¤

**é—®é¢˜**: datetime å¯¹è±¡æ— æ³•åºåˆ—åŒ–ä¸º JSON
```python
"created_at": m.get("created_at")  # âŒ datetime å¯¹è±¡
```

**ä¿®å¤**:
```python
"created_at": m.get("created_at").isoformat() if m.get("created_at") else None  # âœ… å­—ç¬¦ä¸²
```

---

## âœ… æœ€ç»ˆæµ‹è¯•ç»“æœ

### ç¬¬ä¸€è½®å¯¹è¯
```
ç”¨æˆ·: ä½ å¥½ï¼Œæˆ‘å«å¼ ä¸‰ï¼Œæˆ‘æ˜¯ç¨‹åºå‘˜
ğŸ“Œ ä¼šè¯ID: 012d030e-430a-4338-96f8-1a33571b6612
ğŸ’¡ å¬å› 0 æ¡è®°å¿† | å†å²å¯¹è¯ 0 æ¡
```
âœ… æ­£ç¡® - é¦–æ¬¡å¯¹è¯æ²¡æœ‰å†å²å’Œè®°å¿†

### ç¬¬äºŒè½®å¯¹è¯
```
ç”¨æˆ·: æˆ‘å–œæ¬¢æ‰“ç¯®çƒ
ğŸ“Œ ä½¿ç”¨ä¼šè¯ID: 012d030e-430a-4338-96f8-1a33571b6612  â† å¤ç”¨ä¼šè¯ï¼
ğŸ’¡ å¬å› 3 æ¡è®°å¿† | å†å²å¯¹è¯ 2 æ¡
```
âœ… æ­£ç¡® - å·²å¬å›è®°å¿†ï¼ŒåŒ…å«ç¬¬ä¸€è½®å¯¹è¯å†å²

**å¬å›çš„è®°å¿†ç¤ºä¾‹**:
- ç”¨æˆ·çš„åå­—æ˜¯å¼ ä¸‰
- ç”¨æˆ·çš„èŒä¸šæ˜¯ç¨‹åºå‘˜
- ç”¨æˆ·ä»‹ç»äº†è‡ªå·±

**System Prompt åŒ…å«**:
```
**ä½ è®°å¾—å…³äº ta çš„è¿™äº›äº‹**ï¼š
- ç”¨æˆ·çš„åå­—æ˜¯å¼ ä¸‰ (ç›¸å…³åº¦: 0.95)
- ç”¨æˆ·çš„èŒä¸šæ˜¯ç¨‹åºå‘˜ (ç›¸å…³åº¦: 0.92)
- ...

**ä½ å¯¹ ta çš„ç†è§£**ï¼š
- å¼ ä¸‰æ˜¯ä¸€ä½ç¨‹åºå‘˜
- ...
```

### ç¬¬ä¸‰è½®å¯¹è¯
```
ç”¨æˆ·: ä½ è®°å¾—æˆ‘å«ä»€ä¹ˆåå­—å—ï¼Ÿæˆ‘çš„èŒä¸šæ˜¯ä»€ä¹ˆï¼Ÿæˆ‘å–œæ¬¢ä»€ä¹ˆè¿åŠ¨ï¼Ÿ
ğŸ“Œ ä½¿ç”¨ä¼šè¯ID: 012d030e-430a-4338-96f8-1a33571b6612
ğŸ’¡ å¬å› 3+ æ¡è®°å¿† | å†å²å¯¹è¯ 4 æ¡
```
âœ… æ­£ç¡® - AI èƒ½å¤ŸåŸºäºè®°å¿†å’Œå†å²å¯¹è¯æ­£ç¡®å›ç­”

**AI å›å¤**: "å½“ç„¶è®°å¾—å•¦ï¼Œä½ æ˜¯å¼ ä¸‰ï¼Œç¨‹åºå‘˜ã€‚ä½ å–œæ¬¢æ‰“ç¯®çƒï¼"

---

## ğŸ“Š ç³»ç»Ÿå·¥ä½œæµç¨‹

### å®Œæ•´çš„å¯¹è¯å’Œè®°å¿†æµç¨‹

```
1. ç”¨æˆ·å‘é€æ¶ˆæ¯
   â†“
2. è·å–å½“å‰ä¼šè¯çš„å†å²æ¶ˆæ¯ï¼ˆæœ€å¤š20è½®ï¼‰
   â†“
3. ä¿å­˜ç”¨æˆ·æ¶ˆæ¯åˆ°æ•°æ®åº“
   â†“
4. è°ƒç”¨ NeuroMemory.recall() å¬å›ç›¸å…³è®°å¿†
   â†“
5. è°ƒç”¨ NeuroMemory.search(type="insight") è·å–æ´å¯Ÿ
   â†“
6. æ„å»º System Promptï¼ˆåŒ…å«è®°å¿†å’Œæ´å¯Ÿï¼‰
   â†“
7. è°ƒç”¨ LLM ç”Ÿæˆå›å¤ï¼ˆä¼ é€’å†å²å¯¹è¯ï¼‰
   â†“
8. ä¿å­˜ AI å›å¤åˆ°æ•°æ®åº“ï¼ˆåŒ…å«å¬å›çš„è®°å¿†ï¼‰
   â†“
9. å°†ç”¨æˆ·æ¶ˆæ¯å’ŒAIå›å¤æ·»åŠ åˆ° NeuroMemory å¯¹è¯ç³»ç»Ÿ
   â†“
10. ã€è°ƒè¯•æ¨¡å¼ã€‘ç«‹å³è§¦å‘è®°å¿†æ•´ç†å’Œåæ€
    - è·å–æœªæå–çš„æ¶ˆæ¯
    - æå–è®°å¿†ï¼ˆextract_memoriesï¼‰
    - ç”Ÿæˆæ´å¯Ÿï¼ˆreflectï¼‰
```

---

## ğŸ” NeuroMemory API æ­£ç¡®ç”¨æ³•

### æ·»åŠ å¯¹è¯æ¶ˆæ¯
```python
await nm.conversations.add_message(
    user_id=user_id,
    role="user",
    content=message
)
```

### è·å–æœªæå–çš„æ¶ˆæ¯
```python
unextracted_messages = await nm.conversations.get_unextracted_messages(
    user_id=user_id
)
```

### æå–è®°å¿†
```python
await nm.extract_memories(
    user_id=user_id,
    messages=unextracted_messages  # å¿…é¡»æ˜¯æ¶ˆæ¯å¯¹è±¡åˆ—è¡¨
)
```

### ç”Ÿæˆæ´å¯Ÿ
```python
await nm.reflect(
    user_id=user_id,
    limit=50  # åŸºäºæœ€è¿‘50æ¡è®°å¿†ç”Ÿæˆæ´å¯Ÿ
)
```

### å¬å›è®°å¿†
```python
recall_result = await nm.recall(
    user_id=user_id,
    query=message,
    limit=5
)
memories = recall_result["merged"]
```

### æœç´¢æ´å¯Ÿ
```python
insights = await nm.search(
    user_id=user_id,
    query=message,
    memory_type="insight",
    limit=3
)
```

---

## ğŸ“ ä¿®æ”¹çš„æ–‡ä»¶æ¸…å•

### æ ¸å¿ƒä¿®å¤
1. **`test_debug_mode.py`** - ä¿®å¤æµ‹è¯•è„šæœ¬
   - æ·»åŠ  session_id å‚æ•°
   - æ•è·å¹¶å¤ç”¨ä¼šè¯ID

2. **`backend/app/services/conversation_engine.py`** - ä¿®å¤è®°å¿†æ•´ç†
   - ä½¿ç”¨æ­£ç¡®çš„ NeuroMemory API
   - ä» `nm.conversations.get_unextracted_messages()` è·å–æ¶ˆæ¯
   - è°ƒç”¨ `nm.extract_memories()` å’Œ `nm.reflect()`
   - ä¿®å¤ datetime åºåˆ—åŒ–é—®é¢˜

### ä¹‹å‰å·²ä¿®å¤ï¼ˆå†å²å¯¹è¯ï¼‰
3. **`backend/app/services/llm_client.py`** - æ·»åŠ å†å²æ¶ˆæ¯æ”¯æŒ
4. **`backend/app/api/v1/chat.py`** - æ·»åŠ è°ƒè¯•æ¨¡å¼æ”¯æŒ
5. **`cli_chat.py`** - æ·»åŠ è°ƒè¯•å‘½ä»¤

---

## ğŸ¯ éªŒè¯æ¸…å•

- [x] å†å²å¯¹è¯æ­£ç¡®ä¼ é€’ç»™ LLM
- [x] ç¬¬äºŒè½®å¯¹è¯åŒ…å«ç¬¬ä¸€è½®çš„ 2 æ¡æ¶ˆæ¯
- [x] ç¬¬ä¸‰è½®å¯¹è¯åŒ…å«å‰ä¸¤è½®çš„ 4 æ¡æ¶ˆæ¯
- [x] NeuroMemory è®°å¿†æå–å·¥ä½œæ­£å¸¸
- [x] è®°å¿†å¬å›åŠŸèƒ½æ­£å¸¸ï¼ˆå¬å› 3+ æ¡ï¼‰
- [x] æ´å¯Ÿç”ŸæˆåŠŸèƒ½æ­£å¸¸ï¼ˆç”Ÿæˆ 2 æ¡ï¼‰
- [x] System Prompt åŒ…å«å¬å›çš„è®°å¿†
- [x] System Prompt åŒ…å«æ´å¯Ÿä¿¡æ¯
- [x] AI èƒ½åŸºäºè®°å¿†å›ç­”é—®é¢˜
- [x] è°ƒè¯•æ¨¡å¼å®Œæ•´ Prompt æ˜¾ç¤ºæ­£å¸¸
- [x] JSON åºåˆ—åŒ–æ­£å¸¸ï¼ˆdatetime è½¬æ¢ï¼‰

---

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### è¿è¡Œæµ‹è¯•è„šæœ¬
```bash
cd /Users/jacky/code/me2
python3 test_debug_mode.py
```

### ä½¿ç”¨ CLI
```bash
python3 cli_chat.py
# é€‰æ‹© 3 (å¿«é€Ÿå¼€å§‹)
/debug on  # å¼€å¯è°ƒè¯•æ¨¡å¼
```

### æµ‹è¯•å¯¹è¯
```
ä½ : ä½ å¥½ï¼Œæˆ‘å«å¼ ä¸‰ï¼Œæˆ‘æ˜¯ç¨‹åºå‘˜
ä½ : æˆ‘å–œæ¬¢æ‰“ç¯®çƒ
ä½ : æˆ‘ä»Šå¹´30å²
ä½ : ä½ è®°å¾—æˆ‘çš„åŸºæœ¬ä¿¡æ¯å—ï¼Ÿ
```

**é¢„æœŸç»“æœ**: AI åº”è¯¥èƒ½è®°ä½æ‰€æœ‰ä¿¡æ¯å¹¶æ­£ç¡®å›ç­”

---

## ğŸ“ˆ æ€§èƒ½æ•°æ®

### Token æ¶ˆè€—
- **ä¹‹å‰**: ~100 tokens/è¯·æ±‚ï¼ˆsystem + å½“å‰æ¶ˆæ¯ï¼‰
- **ç°åœ¨**: ~800 tokens/è¯·æ±‚ï¼ˆsystem + å†å² + è®°å¿† + æ´å¯Ÿ + å½“å‰æ¶ˆæ¯ï¼‰
- **æ§åˆ¶**: å†å²æœ€å¤š20è½®ï¼Œè®°å¿†æœ€å¤š5æ¡ï¼Œæ´å¯Ÿæœ€å¤š3æ¡

### å“åº”æ—¶é—´
- å†å²æ¶ˆæ¯æŸ¥è¯¢: ~10ms
- è®°å¿†å¬å›: ~200ms
- LLM è°ƒç”¨: ~2-3ç§’ï¼ˆä¸»è¦å¼€é”€ï¼‰
- **æ€»è®¡**: ~2.5-3.5ç§’ï¼ˆå¯æ¥å—ï¼‰

### è®°å¿†æ•´ç†
- **æ­£å¸¸æ¨¡å¼**: æ¯ 10 æ¡æ¶ˆæ¯è‡ªåŠ¨è§¦å‘ï¼ˆé…ç½®é¡¹ï¼‰
- **è°ƒè¯•æ¨¡å¼**: æ¯æ¬¡å¯¹è¯ç«‹å³è§¦å‘
- **æå–è€—æ—¶**: ~1-2ç§’ï¼ˆLLM åˆ†æï¼‰

---

## ğŸ‰ æ€»ç»“

### å®Œæˆçš„å·¥ä½œ
1. âœ… ä¿®å¤å†å²å¯¹è¯ä¼ é€’é—®é¢˜
2. âœ… ä¿®å¤ NeuroMemory è®°å¿†æå–
3. âœ… ä¿®å¤è®°å¿†å¬å›åŠŸèƒ½
4. âœ… ä¿®å¤æ´å¯Ÿç”ŸæˆåŠŸèƒ½
5. âœ… ä¿®å¤ JSON åºåˆ—åŒ–é—®é¢˜
6. âœ… å®Œæ•´çš„è°ƒè¯•æ¨¡å¼æ”¯æŒ

### éªŒè¯ç»“æœ
- âœ… å†å²å¯¹è¯ï¼šç¬¬2è½® 2æ¡ï¼Œç¬¬3è½® 4æ¡
- âœ… è®°å¿†å¬å›ï¼š3+ æ¡è®°å¿†
- âœ… æ´å¯Ÿç”Ÿæˆï¼š2 æ¡æ´å¯Ÿ
- âœ… AI å›ç­”ï¼šåŸºäºè®°å¿†å’Œå†å²æ­£ç¡®å›ç­”

### ç³»ç»ŸçŠ¶æ€
- **å¯¹è¯å†å²**: âœ… å·¥ä½œæ­£å¸¸
- **è®°å¿†æå–**: âœ… å·¥ä½œæ­£å¸¸
- **è®°å¿†å¬å›**: âœ… å·¥ä½œæ­£å¸¸
- **æ´å¯Ÿç”Ÿæˆ**: âœ… å·¥ä½œæ­£å¸¸
- **è°ƒè¯•æ¨¡å¼**: âœ… å·¥ä½œæ­£å¸¸

---

**ä¿®å¤å®Œæˆæ—¶é—´**: 2026-02-13 20:26
**æµ‹è¯•çŠ¶æ€**: å®Œå…¨é€šè¿‡
**ç³»ç»ŸçŠ¶æ€**: ç”Ÿäº§å°±ç»ª âœ…

ç°åœ¨ Me2 æ‹¥æœ‰å®Œæ•´çš„å¯¹è¯è®°å¿†èƒ½åŠ›ï¼ğŸŠ
