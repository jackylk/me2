# Me2 æ¶æ„è®¾è®¡ v2

## é¡¹ç›®å®šä½

Me2 æ˜¯ä¸€ä¸ª**æ¸©æš–é™ªä¼´å¼çš„ Web Chat åº”ç”¨**ï¼Œè®©ç”¨æˆ·æ„Ÿè§‰è¢«ç†è§£å’Œæ”¯æŒã€‚

**æ ¸å¿ƒåŸåˆ™**ï¼š
- è®°å¿†ç®¡ç†ï¼šå®Œå…¨å§”æ‰˜ç»™ NeuroMemory
- Me2 ä¸“æ³¨ï¼šWeb åº”ç”¨ + Agent é«˜å±‚é€»è¾‘
- å¤šç”¨æˆ·ï¼šæ”¯æŒæ³¨å†Œç™»å½•ï¼Œæ¯ä¸ªç”¨æˆ·ç‹¬ç«‹è®°å¿†

---

## æŠ€æœ¯æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Me2 Web App                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   Frontend       â”‚         â”‚    Backend          â”‚ â”‚
â”‚  â”‚   Next.js 14     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚    FastAPI          â”‚ â”‚
â”‚  â”‚   - èŠå¤©ç•Œé¢      â”‚   API   â”‚    - ç”¨æˆ·è®¤è¯       â”‚ â”‚
â”‚  â”‚   - ç”¨æˆ·ç™»å½•      â”‚         â”‚    - å¯¹è¯å¼•æ“       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚    - ä¸»åŠ¨å…³å¿ƒ       â”‚ â”‚
â”‚                                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                           â”‚            â”‚
â”‚                                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚                                â”‚   NeuroMemory       â”‚ â”‚
â”‚                                â”‚   - è®°å¿†å­˜å‚¨         â”‚ â”‚
â”‚                                â”‚   - è®°å¿†å¬å›         â”‚ â”‚
â”‚                                â”‚   - è‡ªåŠ¨æå–         â”‚ â”‚
â”‚                                â”‚   - æƒ…æ„Ÿæ ‡æ³¨         â”‚ â”‚
â”‚                                â”‚   - æ´å¯Ÿç”Ÿæˆ         â”‚ â”‚
â”‚                                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                           â”‚            â”‚
â”‚                                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚                                â”‚   PostgreSQL        â”‚ â”‚
â”‚                                â”‚   - users (Me2)     â”‚ â”‚
â”‚                                â”‚   - embeddings (NM) â”‚ â”‚
â”‚                                â”‚   - conversations   â”‚ â”‚
â”‚                                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## åç«¯æ¨¡å—

### æ ¸å¿ƒæ¨¡å—ï¼ˆç®€åŒ–ç‰ˆï¼‰

```
backend/app/
â”œâ”€â”€ main.py                      # FastAPI ä¸»åº”ç”¨
â”œâ”€â”€ config.py                    # é…ç½®ç®¡ç†
â”œâ”€â”€ db/
â”‚   â”œâ”€â”€ database.py              # æ•°æ®åº“è¿æ¥
â”‚   â””â”€â”€ models.py                # User æ¨¡å‹ï¼ˆåªéœ€è¦ç”¨æˆ·è¡¨ï¼‰
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ memory_manager.py        # NeuroMemory å°è£…ï¼ˆæ ¸å¿ƒï¼‰
â”‚   â”œâ”€â”€ conversation_engine.py   # å¯¹è¯å¼•æ“ï¼ˆé«˜å±‚é€»è¾‘ï¼‰
â”‚   â”œâ”€â”€ proactive_engine.py      # ä¸»åŠ¨å…³å¿ƒï¼ˆç®€åŒ–ç‰ˆï¼‰
â”‚   â””â”€â”€ auth_service.py          # ç”¨æˆ·è®¤è¯ï¼ˆJWTï¼‰
â””â”€â”€ api/v1/
    â”œâ”€â”€ auth.py                  # æ³¨å†Œ/ç™»å½• API
    â”œâ”€â”€ chat.py                  # èŠå¤© API
    â””â”€â”€ user.py                  # ç”¨æˆ·ä¿¡æ¯ API
```

### åˆ é™¤çš„æ¨¡å—
- âŒ `neuromemory_client.py` - ä¸éœ€è¦ HTTP å®¢æˆ·ç«¯
- âŒ `memories.py` - è®°å¿†ç®¡ç†äº¤ç»™ NeuroMemory
- âŒ `profile.py` - ç”»åƒä¿¡æ¯ä» NeuroMemory è·å–
- âŒ `import_api.py` - ä½¿ç”¨ NeuroMemory æ‰¹é‡å¯¼å…¥
- âŒ `image_storage.py` - ä½¿ç”¨ NeuroMemory æ–‡ä»¶ç®¡ç†
- âŒ `mimic_engine.py` - ç®€åŒ–ï¼ŒåªåšåŸºç¡€è¯­è¨€é£æ ¼
- âŒ `deep_mimic_engine.py` - æ´å¯Ÿäº¤ç»™ NeuroMemory

---

## æ•°æ®åº“è®¾è®¡

### PostgreSQL è¡¨ç»“æ„

**Me2 è‡ªå·±çš„è¡¨**ï¼ˆåªéœ€è¦ç”¨æˆ·è¡¨ï¼‰ï¼š
```sql
-- ç”¨æˆ·è¡¨
CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    username VARCHAR(50) UNIQUE NOT NULL,
    email VARCHAR(255) UNIQUE NOT NULL,
    hashed_password VARCHAR(255) NOT NULL,
    created_at TIMESTAMP DEFAULT NOW(),
    last_login TIMESTAMP
);
```

**NeuroMemory çš„è¡¨**ï¼ˆè‡ªåŠ¨åˆ›å»ºï¼‰ï¼š
- embeddingsï¼ˆè®°å¿†å‘é‡ï¼‰
- conversationsï¼ˆå¯¹è¯å†å²ï¼‰
- kv_storeï¼ˆKV å­˜å‚¨ï¼‰
- graph nodes/edgesï¼ˆçŸ¥è¯†å›¾è°±ï¼‰
- ... å…¶ä»– NeuroMemory è¡¨

---

## æ ¸å¿ƒæµç¨‹

### 1. ç”¨æˆ·æ³¨å†Œ/ç™»å½•
```
POST /api/v1/auth/register
  â†’ åˆ›å»ºç”¨æˆ·
  â†’ è¿”å› JWT token

POST /api/v1/auth/login
  â†’ éªŒè¯å¯†ç 
  â†’ è¿”å› JWT token
```

### 2. èŠå¤©æµç¨‹
```
ç”¨æˆ·å‘é€æ¶ˆæ¯
    â†“
POST /api/v1/chat
    â†“
1. éªŒè¯ JWT tokenï¼Œè·å– user_id
    â†“
2. MemoryManager.recall(user_id, message)
   - NeuroMemory ä¸‰å› å­æ£€ç´¢
   - è¿”å›ç›¸å…³è®°å¿† + æ´å¯Ÿ
    â†“
3. ConversationEngine.chat()
   - æ„å»º promptï¼ˆæ³¨å…¥è®°å¿†å’Œæ´å¯Ÿï¼‰
   - è°ƒç”¨ LLMï¼ˆDeepSeekï¼‰
   - ç”Ÿæˆæ¸©æš–ã€æ‡‚ ta çš„å›å¤
    â†“
4. MemoryManager.save_conversation()
   - ä¿å­˜å¯¹è¯åˆ° NeuroMemory
   - è‡ªåŠ¨è§¦å‘è®°å¿†æå–ï¼ˆExtractionStrategyï¼‰
    â†“
5. è¿”å›å›å¤ç»™å‰ç«¯
```

### 3. ä¸»åŠ¨å…³å¿ƒï¼ˆå®šæ—¶ä»»åŠ¡ï¼‰
```
æ¯å°æ—¶æ‰§è¡Œï¼š
    â†“
ProactiveEngine.check_users()
    â†“
å¯¹æ¯ä¸ªç”¨æˆ·ï¼š
1. è·å–æœ€è¿‘è®°å¿†çš„æƒ…æ„Ÿæ ‡æ³¨
2. åˆ¤æ–­æ˜¯å¦éœ€è¦å…³å¿ƒ
3. ç”Ÿæˆä¸»åŠ¨æ¶ˆæ¯ï¼ˆå¦‚æœéœ€è¦ï¼‰
4. é€šè¿‡ WebSocket æ¨é€ç»™å‰ç«¯
```

---

## æ ¸å¿ƒä»£ç ç»“æ„

### 1. MemoryManagerï¼ˆNeuroMemory å°è£…ï¼‰

```python
# backend/app/services/memory_manager.py
from neuromemory import NeuroMemory, SiliconFlowEmbedding, OpenAILLM, ExtractionStrategy

class MemoryManager:
    """ç»Ÿä¸€çš„è®°å¿†ç®¡ç†å™¨ï¼Œå°è£… NeuroMemory v2"""

    def __init__(self):
        self.nm = None

    async def init(self, config):
        """åˆå§‹åŒ– NeuroMemory"""
        self.nm = NeuroMemory(
            database_url=config.DATABASE_URL,
            embedding=SiliconFlowEmbedding(api_key=config.SILICONFLOW_API_KEY),
            llm=OpenAILLM(
                api_key=config.DEEPSEEK_API_KEY,
                model="deepseek-chat",
                base_url="https://api.deepseek.com/v1"
            ),
            extraction=ExtractionStrategy(
                message_interval=10,      # æ¯ 10 æ¡æ¶ˆæ¯æå–
                reflection_interval=50,   # æ¯ 50 æ¬¡æå–ååæ€
            ),
            graph_enabled=True,
        )
        await self.nm.init()

    async def recall(self, user_id: str, query: str):
        """å¬å›è®°å¿†ï¼ˆä¸‰å› å­æ£€ç´¢ + æ´å¯Ÿï¼‰"""
        # 1. ä¸‰å› å­æ£€ç´¢ç›¸å…³è®°å¿†
        recall_result = await self.nm.recall(user_id, query, limit=5)

        # 2. è·å–æ´å¯Ÿ
        insights = await self.nm.search(
            user_id, query,
            memory_type="insight",
            limit=3
        )

        return {
            "memories": recall_result["merged"],
            "insights": insights
        }

    async def save_message(self, user_id: str, role: str, content: str):
        """ä¿å­˜å¯¹è¯ï¼ˆè‡ªåŠ¨è§¦å‘è®°å¿†æå–ï¼‰"""
        await self.nm.conversations.add_message(user_id, role, content)
```

### 2. ConversationEngineï¼ˆå¯¹è¯å¼•æ“ï¼‰

```python
# backend/app/services/conversation_engine.py

class ConversationEngine:
    """å¯¹è¯å¼•æ“ - Me2 çš„é«˜å±‚é€»è¾‘"""

    def __init__(self, memory_manager: MemoryManager, llm_client):
        self.memory = memory_manager
        self.llm = llm_client

    async def chat(self, user_id: str, message: str):
        """å¤„ç†å¯¹è¯ - æ¸©æš–ã€æ‡‚ ta çš„å›å¤"""

        # 1. å¬å›è®°å¿†å’Œæ´å¯Ÿ
        context = await self.memory.recall(user_id, message)

        # 2. æ„å»ºæ¸©æš–çš„ prompt
        system_prompt = self._build_warm_prompt(context)

        # 3. è°ƒç”¨ LLM
        response = await self.llm.chat(
            system_prompt=system_prompt,
            user_message=message,
            temperature=0.8  # ç¨é«˜æ¸©åº¦ï¼Œæ›´è‡ªç„¶
        )

        # 4. ä¿å­˜å¯¹è¯ï¼ˆNeuroMemory è‡ªåŠ¨æå–è®°å¿†ï¼‰
        await self.memory.save_message(user_id, "user", message)
        await self.memory.save_message(user_id, "assistant", response)

        return response

    def _build_warm_prompt(self, context):
        """æ„å»ºæ¸©æš–ã€æ”¯æŒæ€§çš„ prompt"""

        memories = context["memories"]
        insights = context["insights"]

        # æå–æƒ…æ„Ÿä¿¡æ¯
        emotional_context = self._extract_emotional_context(memories)

        return f"""ä½ æ˜¯ä¸€ä¸ªæ¸©æš–ã€æ‡‚ ta çš„æœ‹å‹ã€‚

**ä½ è®°å¾—å…³äº ta çš„è¿™äº›äº‹**ï¼š
{self._format_memories(memories)}

**ä½ å¯¹ ta çš„ç†è§£**ï¼š
{self._format_insights(insights)}

{emotional_context}

**é‡è¦**ï¼š
- åƒçœŸæ­£çš„æœ‹å‹ä¸€æ ·å¯¹è¯ï¼Œè‡ªç„¶åœ°æåŠä½ è®°å¾—çš„äº‹
- å¦‚æœ ta æƒ…ç»ªä½è½ï¼Œç»™äºˆæ¸©æš–çš„æ”¯æŒ
- å¦‚æœ ta åˆ†äº«å¼€å¿ƒçš„äº‹ï¼ŒçœŸè¯šåœ°ä¸º ta é«˜å…´
- ä¸è¦æœºæ¢°åœ°å¤è¿°è®°å¿†ï¼Œè¦è‡ªç„¶èå…¥å¯¹è¯
- è®© ta æ„Ÿè§‰è¢«ç†è§£ã€è¢«æ”¯æŒ"""

    def _extract_emotional_context(self, memories):
        """æå–æƒ…æ„Ÿä¸Šä¸‹æ–‡"""
        emotions = []
        for m in memories:
            meta = m.get("metadata", {})
            if "emotion" in meta and meta["emotion"]:
                emotions.append(meta["emotion"])

        if not emotions:
            return ""

        avg_valence = sum(e["valence"] for e in emotions) / len(emotions)

        if avg_valence < -0.3:
            return "\n**æ³¨æ„**: ta æœ€è¿‘æƒ…ç»ªä¼¼ä¹æœ‰äº›ä½è½ï¼Œè¯·ç»™äºˆå…³å¿ƒå’Œæ”¯æŒã€‚"
        elif avg_valence > 0.3:
            return "\n**æ³¨æ„**: ta æœ€è¿‘å¿ƒæƒ…ä¸é”™ï¼Œå¯ä»¥åˆ†äº« ta çš„å¿«ä¹ã€‚"

        return ""
```

### 3. API ç«¯ç‚¹

```python
# backend/app/api/v1/chat.py
from fastapi import APIRouter, Depends
from app.services.auth_service import get_current_user

router = APIRouter()

@router.post("/chat")
async def chat(
    message: str,
    current_user = Depends(get_current_user)  # JWT éªŒè¯
):
    """èŠå¤© API"""
    user_id = current_user.id

    # è°ƒç”¨å¯¹è¯å¼•æ“
    response = await conversation_engine.chat(user_id, message)

    return {"response": response}
```

---

## å‰ç«¯è®¾è®¡

### ç®€åŒ–çš„é¡µé¢ç»“æ„
```
frontend/app/
â”œâ”€â”€ page.tsx                 # ç™»å½•é¡µï¼ˆé¦–é¡µï¼‰
â”œâ”€â”€ register/page.tsx        # æ³¨å†Œé¡µ
â”œâ”€â”€ chat/page.tsx            # èŠå¤©é¡µï¼ˆä¸»ç•Œé¢ï¼‰
â””â”€â”€ layout.tsx               # æ ¹å¸ƒå±€
```

### æ ¸å¿ƒç»„ä»¶
```
frontend/components/
â”œâ”€â”€ LoginForm.tsx            # ç™»å½•è¡¨å•
â”œâ”€â”€ RegisterForm.tsx         # æ³¨å†Œè¡¨å•
â”œâ”€â”€ ChatInterface.tsx        # èŠå¤©ç•Œé¢
â””â”€â”€ Navigation.tsx           # å¯¼èˆªæ 
```

---

## éƒ¨ç½²æ–¹æ¡ˆ

### Railway éƒ¨ç½²

**éœ€è¦çš„æœåŠ¡**ï¼š
1. Web Serviceï¼ˆFastAPI + Next.jsï¼‰
2. PostgreSQL Databaseï¼ˆRailway æä¾›ï¼‰

**ç¯å¢ƒå˜é‡**ï¼š
```bash
# Railway ç¯å¢ƒå˜é‡
DATABASE_URL=postgresql://...  # Railway è‡ªåŠ¨æä¾›
SILICONFLOW_API_KEY=sk-...
DEEPSEEK_API_KEY=sk-...
JWT_SECRET=...
```

**Dockerfile**ï¼š
```dockerfile
# å‰ç«¯æ„å»º
FROM node:18 AS frontend
WORKDIR /app/frontend
COPY frontend/package*.json ./
RUN npm install
COPY frontend ./
RUN npm run build

# åç«¯
FROM python:3.10
WORKDIR /app

# å¤åˆ¶å‰ç«¯æ„å»ºäº§ç‰©
COPY --from=frontend /app/frontend/.next ./frontend/.next
COPY --from=frontend /app/frontend/public ./frontend/public

# å®‰è£… Python ä¾èµ–
COPY backend/requirements.txt ./
RUN pip install -r requirements.txt

# å¤åˆ¶åç«¯ä»£ç 
COPY backend ./backend

# å¯åŠ¨
CMD uvicorn backend.app.main:app --host 0.0.0.0 --port $PORT
```

---

## å®æ–½è®¡åˆ’

### Phase 1: æ ¸å¿ƒé‡æ„ï¼ˆ1 å‘¨ï¼‰
- [ ] åˆ›å»ºæ–°çš„ `memory_manager.py`
- [ ] ç®€åŒ– `conversation_engine.py`
- [ ] æ·»åŠ ç”¨æˆ·è®¤è¯ç³»ç»Ÿï¼ˆJWTï¼‰
- [ ] æ›´æ–°å‰ç«¯ç™»å½•/æ³¨å†Œé¡µé¢

### Phase 2: åŠŸèƒ½å®Œå–„ï¼ˆ3 å¤©ï¼‰
- [ ] ç®€åŒ–ä¸»åŠ¨å…³å¿ƒï¼ˆåŸºäºæƒ…æ„Ÿæ ‡æ³¨ï¼‰
- [ ] æµ‹è¯•èŠå¤©æµç¨‹
- [ ] å‰ç«¯ç¾åŒ–

### Phase 3: éƒ¨ç½²ä¸Šçº¿ï¼ˆ2 å¤©ï¼‰
- [ ] æœ¬åœ°æµ‹è¯•
- [ ] Railway é…ç½®
- [ ] ä¸Šçº¿æµ‹è¯•

---

## ä¸‹ä¸€æ­¥

éœ€è¦æˆ‘å¼€å§‹å®æ–½å—ï¼Ÿæˆ‘å¯ä»¥ï¼š
1. åˆ›å»ºæ–°çš„ `memory_manager.py`
2. é‡æ„ `conversation_engine.py`
3. æ·»åŠ ç”¨æˆ·è®¤è¯ç³»ç»Ÿ
4. æ¸…ç†ä¸éœ€è¦çš„ä»£ç 

Ready to start? ğŸš€
