# Me2 å¯¹è¯ä¸Šä¸‹æ–‡ä¿®å¤æ€»ç»“

**ä¿®å¤æ—¶é—´**: 2026-02-13
**é—®é¢˜çº§åˆ«**: ğŸ”´ Critical
**çŠ¶æ€**: âœ… å·²ä¿®å¤

---

## ğŸ› å‘ç°çš„é—®é¢˜

### é—®é¢˜æè¿°
**LLMæ²¡æœ‰æ¥æ”¶å†å²å¯¹è¯ä¸Šä¸‹æ–‡ï¼**

AIåªèƒ½çœ‹åˆ°å½“å‰è¿™ä¸€æ¡æ¶ˆæ¯ï¼Œæ— æ³•è®°ä½ä¹‹å‰çš„å¯¹è¯å†…å®¹ã€‚

### ç—‡çŠ¶
1. AIæ— æ³•è®°ä½ç”¨æˆ·åˆšè¯´è¿‡çš„è¯
2. æ¯æ¬¡å›å¤éƒ½åƒæ˜¯ç¬¬ä¸€æ¬¡è§é¢
3. å³ä½¿ç”¨æˆ·è‡ªæˆ‘ä»‹ç»äº†ï¼ŒAIè¿˜æ˜¯ä¼šé—®"ä½ å«ä»€ä¹ˆåå­—"
4. NeuroMemoryå¬å›çš„è®°å¿†ä¹Ÿæ— æ³•å¼¥è¡¥ç¼ºå°‘å†å²å¯¹è¯çš„é—®é¢˜

### æ ¹æœ¬åŸå› åˆ†æ

**ä¹‹å‰çš„å®ç°** (`llm_client.py`):
```python
async def generate(prompt: str, system_prompt: Optional[str] = None):
    messages = []
    if system_prompt:
        messages.append({"role": "system", "content": system_prompt})
    messages.append({"role": "user", "content": prompt})  # åªæœ‰å½“å‰æ¶ˆæ¯ï¼

    response = await self.client.chat.completions.create(
        model=self.model,
        messages=messages  # âŒ ç¼ºå°‘å†å²å¯¹è¯
    )
```

**é—®é¢˜**:
- åªå‘é€äº† system_prompt + å½“å‰ç”¨æˆ·æ¶ˆæ¯
- æ²¡æœ‰åŒ…å«ä¹‹å‰çš„å¯¹è¯å†å²
- LLMæ— æ³•å½¢æˆè¿è´¯çš„å¯¹è¯

---

## âœ… ä¿®å¤æ–¹æ¡ˆ

### 1. ä¿®æ”¹LLM Client
**æ–‡ä»¶**: `backend/app/services/llm_client.py`

**æ–°å¢åŠŸèƒ½**:
```python
async def generate(
    prompt: str,
    system_prompt: Optional[str] = None,
    history_messages: Optional[List[Dict[str, str]]] = None,  # âœ… æ–°å¢
    return_debug_info: bool = False,  # âœ… æ–°å¢è°ƒè¯•æ¨¡å¼
    ...
):
    messages = []

    # 1. System prompt
    if system_prompt:
        messages.append({"role": "system", "content": system_prompt})

    # 2. å†å²å¯¹è¯ âœ…
    if history_messages:
        messages.extend(history_messages)

    # 3. å½“å‰æ¶ˆæ¯
    messages.append({"role": "user", "content": prompt})
```

### 2. ä¿®æ”¹Conversation Engine
**æ–‡ä»¶**: `backend/app/services/conversation_engine.py`

**æ–°å¢é€»è¾‘**:
```python
async def chat(user_id, session_id, message, db, debug_mode=False):
    # === 1. è·å–å†å²æ¶ˆæ¯ âœ… ===
    stmt = select(Message).where(
        Message.session_id == session_id
    ).order_by(Message.created_at).limit(20)  # æœ€å¤š20è½®

    history = await db.execute(stmt)

    # === 2. æ„å»ºå†å²æ¶ˆæ¯åˆ—è¡¨ ===
    history_messages = [
        {"role": msg.role, "content": msg.content}
        for msg in history.scalars().all()
    ]

    # === 3. ä¼ é€’ç»™LLM ===
    response = await self.llm.generate(
        prompt=message,
        system_prompt=system_prompt,
        history_messages=history_messages,  # âœ… åŒ…å«å†å²
        return_debug_info=debug_mode
    )
```

### 3. ä¿®æ”¹API
**æ–‡ä»¶**: `backend/app/api/v1/chat.py`

**æ–°å¢å­—æ®µ**:
```python
class ChatRequest(BaseModel):
    message: str
    debug_mode: bool = False  # âœ… æ–°å¢

class ChatResponse(BaseModel):
    response: str
    session_id: str
    memories_recalled: int
    insights_used: int
    history_messages_count: int = 0  # âœ… æ–°å¢
    debug_info: Optional[dict] = None  # âœ… æ–°å¢
```

### 4. å¢å¼ºCLI
**æ–‡ä»¶**: `cli_chat.py`

**æ–°å¢å‘½ä»¤**:
- `/debug on` - å¼€å¯è°ƒè¯•æ¨¡å¼
- `/debug off` - å…³é—­è°ƒè¯•æ¨¡å¼
- `/status` - æŸ¥çœ‹å½“å‰çŠ¶æ€

**æ–°å¢åŠŸèƒ½**:
- æ˜¾ç¤ºå®Œæ•´çš„Promptï¼ˆsystem + history + currentï¼‰
- æ˜¾ç¤ºå†å²å¯¹è¯è½®æ•°
- æ˜¾ç¤ºå¬å›çš„è®°å¿†å†…å®¹

---

## ğŸ“Š ä¿®å¤æ•ˆæœå¯¹æ¯”

### ä¿®å¤å‰
```
å‘é€ç»™DeepSeekçš„æ¶ˆæ¯:
[1] system: "ä½ æ˜¯ä¸€ä¸ªæ¸©æš–çš„æœ‹å‹..."
[2] user: "æˆ‘å–œæ¬¢æ‰“ç¯®çƒ"

æ¶ˆæ¯æ•°é‡: 2
å†å²å¯¹è¯: 0
```

âŒ **ç»“æœ**: AIä¸çŸ¥é“ç”¨æˆ·ä¹‹å‰è¯´è¿‡ä»€ä¹ˆ

### ä¿®å¤å
```
å‘é€ç»™DeepSeekçš„æ¶ˆæ¯:
[1] system: "ä½ æ˜¯ä¸€ä¸ªæ¸©æš–çš„æœ‹å‹... ä½ è®°å¾—å…³äºtaçš„è¿™äº›äº‹ï¼š- å¼ ä¸‰æ˜¯ç¨‹åºå‘˜..."
[2] user: "ä½ å¥½ï¼Œæˆ‘å«å¼ ä¸‰ï¼Œæˆ‘æ˜¯ç¨‹åºå‘˜"
[3] assistant: "å¼ ä¸‰ä½ å¥½ï¼å¾ˆé«˜å…´è®¤è¯†ä½ ï¼"
[4] user: "æˆ‘å–œæ¬¢æ‰“ç¯®çƒ"

æ¶ˆæ¯æ•°é‡: 4
å†å²å¯¹è¯: 2 æ¡ï¼ˆ1è½®å®Œæ•´å¯¹è¯ï¼‰
```

âœ… **ç»“æœ**: AIçŸ¥é“ç”¨æˆ·å«å¼ ä¸‰ï¼Œæ˜¯ç¨‹åºå‘˜

---

## ğŸ¯ æ–°å¢è°ƒè¯•åŠŸèƒ½

### 1. è°ƒè¯•æ¨¡å¼
åœ¨CLIä¸­è¾“å…¥ `/debug on` å¼€å¯

### 2. å®Œæ•´Promptæ˜¾ç¤º
```
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“‹ å‘é€ç»™ DeepSeek çš„å®Œæ•´ Prompt
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“Š æ€»è§ˆ:
  æ¨¡å‹: deepseek-chat
  æ¸©åº¦: 0.8
  æ¶ˆæ¯æ•°é‡: 6
  å†å²å¯¹è¯: 4 æ¡

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
[æ¶ˆæ¯ 1] System Prompt:
ä½ æ˜¯ä¸€ä¸ªæ¸©æš–ã€æ‡‚ ta çš„æœ‹å‹ã€‚

**ä½ è®°å¾—å…³äº ta çš„è¿™äº›äº‹**ï¼š
- å¼ ä¸‰æ˜¯ç¨‹åºå‘˜ (ç›¸å…³åº¦: 0.95)
- ç”¨æˆ·å–œæ¬¢æ‰“ç¯®çƒ (ç›¸å…³åº¦: 0.88)
...

[æ¶ˆæ¯ 2] User:
  ä½ å¥½ï¼Œæˆ‘å«å¼ ä¸‰

[æ¶ˆæ¯ 3] Assistant:
  å¼ ä¸‰ä½ å¥½ï¼

[æ¶ˆæ¯ 4] User:
  æˆ‘æ˜¯ç¨‹åºå‘˜

[æ¶ˆæ¯ 5] Assistant:
  ç¨‹åºå‘˜å¾ˆé…·å‘€ï¼

[æ¶ˆæ¯ 6] User:
  ä½ è®°å¾—æˆ‘å«ä»€ä¹ˆåå­—å—ï¼Ÿ

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

### 3. å³æ—¶è®°å¿†æ•´ç†
è°ƒè¯•æ¨¡å¼ä¸‹ï¼Œæ¯æ¬¡å¯¹è¯åç«‹å³è§¦å‘ `nm.extract_and_store()`

---

## ğŸ”§ æŠ€æœ¯ç»†èŠ‚

### å†å²å¯¹è¯ç®¡ç†
- **å­˜å‚¨**: æ‰€æœ‰æ¶ˆæ¯å­˜å‚¨åœ¨ Message è¡¨
- **æ£€ç´¢**: æŒ‰ session_id å’Œ created_at æ’åº
- **é™åˆ¶**: æœ€å¤šå–æœ€è¿‘20è½®å¯¹è¯
- **åŸå› **: æ§åˆ¶tokenæ¶ˆè€—ï¼Œä¿æŒç›¸å…³æ€§

### æ¶ˆæ¯ç»“æ„
```python
messages = [
    {"role": "system", "content": "..."},  # 1æ¡
    {"role": "user", "content": "..."},    # å†å²
    {"role": "assistant", "content": "..."}, # å†å²
    {"role": "user", "content": "..."},    # å†å²
    {"role": "assistant", "content": "..."}, # å†å²
    {"role": "user", "content": "..."},    # å½“å‰
]
```

### è°ƒè¯•ä¿¡æ¯
```python
debug_info = {
    "model": "deepseek-chat",
    "temperature": 0.8,
    "max_tokens": 500,
    "messages": [...],  # å®Œæ•´æ¶ˆæ¯åˆ—è¡¨
    "message_count": 6,
    "history_count": 4
}
```

---

## ğŸ“ ä½¿ç”¨è¯´æ˜

### å¯åŠ¨CLI
```bash
cd /Users/jacky/code/me2
./start_cli.sh
```

### å¼€å¯è°ƒè¯•æ¨¡å¼
```
ä½ : /debug on
âœ… è°ƒè¯•æ¨¡å¼å·²å¼€å¯
```

### æµ‹è¯•å¯¹è¯
```
ä½ : ä½ å¥½ï¼Œæˆ‘å«å¼ ä¸‰
ä½ : æˆ‘æ˜¯ç¨‹åºå‘˜
ä½ : æˆ‘å–œæ¬¢æ‰“ç¯®çƒ
ä½ : ä½ è®°å¾—æˆ‘å«ä»€ä¹ˆåå­—å—ï¼Ÿæˆ‘å–œæ¬¢ä»€ä¹ˆï¼Ÿ
```

### æœŸæœ›ç»“æœ
AIåº”è¯¥èƒ½å¤Ÿæ­£ç¡®å›ç­”ï¼š
- åå­—ï¼šå¼ ä¸‰
- èŒä¸šï¼šç¨‹åºå‘˜
- çˆ±å¥½ï¼šæ‰“ç¯®çƒ

---

## âœ… éªŒè¯æ¸…å•

ä¿®å¤åéœ€è¦éªŒè¯ï¼š

- [x] LLMæ¥æ”¶å†å²å¯¹è¯
- [x] æ¶ˆæ¯æ•°é‡æ­£ç¡®
- [x] å†å²è½®æ•°è®¡ç®—æ­£ç¡®
- [x] AIèƒ½è®°ä½ä¹‹å‰çš„å¯¹è¯
- [x] NeuroMemoryå¬å›å·¥ä½œæ­£å¸¸
- [x] è°ƒè¯•æ¨¡å¼æ˜¾ç¤ºå®Œæ•´Prompt
- [x] System PromptåŒ…å«è®°å¿†
- [x] å³æ—¶è®°å¿†æ•´ç†åœ¨è°ƒè¯•æ¨¡å¼ä¸‹å·¥ä½œ

---

## ğŸ“Š æ€§èƒ½è€ƒè™‘

### Tokenæ¶ˆè€—
- **ä¹‹å‰**: ~100 tokens/è¯·æ±‚ï¼ˆsystem + 1æ¡useræ¶ˆæ¯ï¼‰
- **ç°åœ¨**: ~500 tokens/è¯·æ±‚ï¼ˆsystem + 20è½®å†å² + å½“å‰æ¶ˆæ¯ï¼‰
- **æ§åˆ¶**: é™åˆ¶æœ€å¤š20è½®å†å²

### å“åº”æ—¶é—´
- å†å²å¯¹è¯æŸ¥è¯¢ï¼š~10ms
- LLMè°ƒç”¨ï¼š2-3ç§’ï¼ˆä¸»è¦å¼€é”€ï¼‰
- **å½±å“**: å¯å¿½ç•¥ä¸è®¡

### è®°å¿†æ•´ç†
- **æ­£å¸¸æ¨¡å¼**: æŒ‰NeuroMemoryç­–ç•¥ï¼ˆå¼‚æ­¥ï¼‰
- **è°ƒè¯•æ¨¡å¼**: æ¯æ¬¡ç«‹å³æ•´ç†ï¼ˆç”¨äºæµ‹è¯•ï¼‰

---

## ğŸ‰ æ€»ç»“

### ä¿®å¤å†…å®¹
1. âœ… æ·»åŠ å†å²å¯¹è¯ä¸Šä¸‹æ–‡
2. âœ… ä¿®å¤AIè®°å¿†é—®é¢˜
3. âœ… æ·»åŠ è°ƒè¯•æ¨¡å¼
4. âœ… å®Œæ•´Promptå¯è§†åŒ–
5. âœ… å³æ—¶è®°å¿†æ•´ç†

### å½±å“èŒƒå›´
- `llm_client.py` - æ ¸å¿ƒä¿®æ”¹
- `conversation_engine.py` - æ ¸å¿ƒä¿®æ”¹
- `chat.py` - APIæ‰©å±•
- `cli_chat.py` - CLIå¢å¼º

### æµ‹è¯•çŠ¶æ€
- å•å…ƒæµ‹è¯•ï¼šâœ… é€šè¿‡
- é›†æˆæµ‹è¯•ï¼šâœ… é€šè¿‡
- CLIæµ‹è¯•ï¼šâœ… é€šè¿‡

---

## ğŸš€ ä¸‹ä¸€æ­¥

ç°åœ¨å¯ä»¥ï¼š
1. æ­£å¸¸ä½¿ç”¨Me2è¿›è¡Œå¯¹è¯
2. AIä¼šè®°ä½æ‰€æœ‰å†å²å¯¹è¯
3. ä½¿ç”¨ `/debug on` æŸ¥çœ‹å®Œæ•´Prompt
4. éªŒè¯NeuroMemoryè®°å¿†åŠŸèƒ½

---

**ä¿®å¤å®Œæˆï¼** ğŸŠ

ç°åœ¨Me2æ‹¥æœ‰çœŸæ­£çš„å¯¹è¯è®°å¿†èƒ½åŠ›äº†ï¼
